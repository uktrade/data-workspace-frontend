{% extends 'explorer/base.html' %}

{% load explorer_tags %}

{% block title %}{% if form.errors %}Error: {% endif %}Data Explorer - Home{% endblock %}
{% block content %}
  <div class="govuk-width-container">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full" id="query_area">
        {% if form.errors %}
          <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1"
               data-module="govuk-error-summary">
            <h2 class="govuk-error-summary__title" id="error-summary-title">
              There is a problem
            </h2>
            <div class="govuk-error-summary__body">
              <ul class="govuk-list govuk-error-summary__list">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                    <li>
                      <a href="#id_{{ field }}">{{ error }}</a>
                    </li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}

        <h1 class="govuk-heading-xl govuk-!-margin-bottom-2">
          Welcome to Data Explorer
        </h1>

        <p class="govuk-body govuk-!-margin-top-6 govuk-!-margin-bottom-6">
          You can run a query on this page or see your <a href="{% url 'explorer:list_queries' %}" class="govuk-link">saved
          queries</a>.
        </p>

        <div class="govuk-tabs" data-module="govuk-tabs">
          <h2 class="govuk-tabs__title">
            Contents
          </h2>
          <ul class="govuk-tabs__list">
            <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
              <a class="govuk-tabs__tab" href="#query-tab">
                Query
              </a>
            </li>
            <li class="govuk-tabs__list-item">
              <a class="govuk-tabs__tab" href="#database-tab">
                Database
              </a>
            </li>
          </ul>
          <div class="govuk-tabs__panel" id="query-tab">
            <h2 class="govuk-heading-l">Query</h2>

            <form role="form" action="{{ form_action }}" method="post" id="editor">
              {% csrf_token %}

              <fieldset class="govuk-fieldset">
                {% if form.connections|length > 1 %}
                  <div class="govuk-form-group">
                    <label class="govuk-label" for="id_connection">
                      Connection
                    </label>
                    <select class="govuk-select" id="id_connection" name="connection">
                      {% for value, label in form.connections %}
                        <option value="{{ value|lower }}"{% if form.connection.value == value %} selected{% endif %}>
                          {{ label }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                {% else %}
                  {# still need to submit the connection, just hide the UI element #}
                  <div style="display: none">
                    {{ form.connection }}
                  </div>
                {% endif %}

                {# We apply `id_sql` because that matches the id generated by the form for the `sql` field. We don't use #}
                {# that ID on the GOV.UK textarea itself because it's disabled and hidden, and therefore not a valid anchor #}
                {# target. Placing the id on the form group means that when the error is clicked we are still taken to the #}
                {# correct place on the page. #}
                <div id="id_sql" class="govuk-form-group {% if form.sql.errors %} govuk-form-group--error {% endif %}">
                  <p class="govuk-label">
                    Your SQL query
                  </p>
                  {% if form.sql.errors %}
                    {% for error in form.sql.errors %}
                      <span id="sql-error" class="govuk-error-message">
                              <span class="govuk-visually-hidden">Error:</span> {{ error|escape }}
                          </span>
                    {% endfor %}
                  {% endif %}
                  <div class="govuk-textarea" id="gov-uk-sql-wrapper" rows="10">
                    <div id="ace-sql-editor">{{ form.sql.value|default_if_none:"" }}</div>
                  </div>
                  <textarea aria-label="Sql" style="display: none;"
                            name="sql" id="original-sql">{{ form.sql.value|default_if_none:"" }}</textarea>

                  <div class="govuk-form-group">

                    <button class="govuk-button" data-module="govuk-button" name="action" value="run">
                      Run
                    </button>

                    <button class="govuk-button govuk-button--secondary govuk-!-margin-left-3"
                            data-module="govuk-button" name="action" value="save">
                      Save
                    </button>

                    <button class="govuk-button govuk-button--secondary govuk-!-margin-left-3"
                            data-module="govuk-button" type="button" id="format_button">
                      Format SQL
                    </button>

                  </div>

                  <input aria-label="Title" type="govuk-visually-hidden" value="{{ form.title.value|default_if_none:"Playground Query" }}" name="title" hidden/>
                </div>
              </fieldset>



              {% if headers %}
                <div class="govuk-grid-row">
                  <div class="govuk-grid-column-full">
                    <p class="govuk-heading-m govuk-!-margin-bottom-2">
                      Query result
                    </p>
                    <p class="govuk-body">
                      {% if rows > total_rows %}
                        Showing {{ total_rows }} rows from a total of {{ total_rows }}
                      {% else %}
                        Showing {{ rows }} rows from a total of {{ total_rows }}
                      {% endif %}
                    </p>
                    <p class="govuk-body">
			                Execution time: {{ duration|format_duration }}
                    </p>
                    <div class="scrollable-table">
                      <table class="govuk-table">
                        <thead class="govuk-table">
                        <tr class="govuk-table__row">
                          {% for header in headers %}
                            <th class="govuk-table__header">{{ header }}</th>
                          {% endfor %}
                        </tr>

                        <tbody class="govuk-table__body">
                        {% if data %}
                          {% for row in data %}
                            <tr class="govuk-table__row">
                              {% for column in row %}
                                <td class="govuk-table__cell">
                                  {{ column }}
                                </td>
                              {% endfor %}
                            </tr>
                          {% endfor %}
                        {% endif %}
                        </tbody>

                        </thead>
                      </table>
                    </div>

                    <div class="govuk-grid-row govuk-!-margin-top-4">
                      <div class="govuk-grid-column-full">
                          <span class="govuk-label app-label--inline" for="query-page">Show page </span>
                          <input class="govuk-input govuk-input--width-5 app-input--inline" id="query-page"
                                 name="query-page"
                                 value="{{ page }}"/>
                          <span class="govuk-body"> with </span>
                          <input class="govuk-input govuk-input--width-5 app-input--inline" id="query-rows"
                                 name="query-rows"
                                 value="{{ rows }}" type="number"/>
                          <span class="govuk-label app-label--inline" for="query-rows"> results per page</span>
                          <button class="govuk-button govuk-!-margin-left-5" data-module="govuk-button" name="action" value="fetch-page">
                            Fetch page
                          </button>
                      </div>
                    </div>

                    <button class="govuk-button govuk-button--secondary" data-module="govuk-button" name="action" value="download-csv">
                      Download CSV
                    </button>

                    <button class="govuk-button govuk-button--secondary govuk-!-margin-left-4" data-module="govuk-button" name="action" value="download-excel">
                      Download Excel
                    </button>

                    <button class="govuk-button govuk-button--secondary govuk-!-margin-left-4" data-module="govuk-button" name="action" value="download-json">
                      Download JSON
                    </button>
                  </div>
                </div>
              {% endif %}
            </form>
          </div>
          <div class="govuk-tabs__panel" id="database-tab">
            <h2 class="govuk-heading-l">Database</h2>
            <p class="govuk-body">
              You can see the database tables you have access to here.
            </p>

            {% include 'explorer/schema.html' %}
          </div>
        </div>

      </div>

    </div>

  </div>

{% endblock content %}

{% block init_govuk_frontend %}
  {% load render_bundle from webpack_loader %}
  {% render_bundle 'query' %}
  {% render_bundle 'schema' %}

  <script nonce="{{ request.csp_nonce }}">
    window.GOVUKFrontend.initAll();
    window.initSchemaSearch();
  </script>
{% endblock %}
