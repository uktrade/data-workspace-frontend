{% extends "admin/base_site.html" %}
{% load static explorer_tags admin_urls %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .stats-container {
      display: grid;
      grid-gap: 40px 60px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      grid-auto-rows: 240px;
      grid-auto-flow: dense;
    }
    .stats-container .stat.bad-news {
      background: var(--message-error-bg);
    }
    .stats-container > .stat {
      height:240px;
      width:100%;
      background: var(--darkened-bg);
      overflow: hidden;
    }
    .stats-container > .stat h1, .stats-container > .stat h2, .stats-container > .stat h3 {
      text-align: center;
    }
    .stats-container > .stat h2, .stats-container > .stat h3 {
      font-weight: normal;
    }
    .stats-container > .stat h2 {
      margin-top: 1em;
      margin-left: 0;
      margin-right: 0;
    }
    .stats-container > .stat h1 {
      padding: 41px 0;
      font-size: 4em;
      margin-bottom: 13px;
      font-weight: 400;
    }
    .stats-container .smaller-stat h1 {
      font-size: 3em;
      padding: 49px 0;
    }
    .stats-container > .stat h3 {
      padding-top: 0;
    }
    .stats-container .stat a, .stats-container .stat a:hover, .stats-container .stat a:visited {
      text-decoration: none;
      color: inherit;
    }
  </style>
{% endblock %}
{% block breadcrumbs %}
  <div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; Data Workspace Stats
  </div>
{% endblock breadcrumbs %}
{% block content %}
  {% url 'admin:eventlog_eventlog_changelist' as eventlog_url %}
  <div class="content-main">
    <h1>Data Workspace Stats</h1>
    <div class="stats-container">
      {% if currently_running_tools is not None %}
        <div class="stat">
          <a
            target="_blank"
            href="{% url 'admin:applications_applicationinstance_changelist' %}?state__exact=RUNNING"
          >
            <h2>Currently running tools</h2>
            <h1>{{ currently_running_tools }}</h1>
            <h3>As of {% now "d/m/y H:i" %}</h3>
          </a>
        </div>
      {% endif %}
      {% if failed_tools_24_hours is not None %}
        <div class="stat{% if failed_tools_24_hours > 0 %} bad-news{% endif %}">
          <a
            target="_blank"
            href="{{ eventlog_url }}?event_type__exact={{ eventlog_model.TYPE_USER_TOOL_FAILED }}"
          >
            <h2>Tools failed to start</h2>
            <h1>{{ failed_tools_24_hours }}</h1>
            <h3>In the past 24 hours</h3>
          </a>
        </div>
      {% endif %}
      {% if oldest_running_tool_since is not None %}
        <div class="stat">
          <a
            target="_blank"
            href="{% url 'admin:applications_applicationinstance_changelist' %}?o=3&state__exact=RUNNING"
          >
            <h2>Oldest running tool</h2>
            <h1>{{ oldest_running_tool_since }}</h1>
            <h3>Started: {{ oldest_running_tool_date|date:"d/m/y H:i" }}</h3>
          </a>
        </div>
      {% endif %}
      {% if tool_start_duration_7_days is not None %}
        <div class="stat{% if tool_start_duration_7_days >= 3_600_000 %} smaller-stat{% endif %}{% if tool_start_duration_7_days > 180_000 %} bad-news{% endif %}">
          <h2>Average tool load time</h2>
          <h1>{{ tool_start_duration_7_days|format_duration_short }}</h1>
          <h3>In the past 7 days</h3>
        </div>
      {% endif %}
      {% if data_grid_timeouts_24_hours is not None %}
        <div class="stat{% if data_grid_timeouts_24_hours > 0 %} bad-news{% endif %}">
          <a
            target="_blank"
            href="{{ eventlog_url }}?event_type__exact={{ eventlog_model.TYPE_DATA_PREVIEW_TIMEOUT }}"
          >
            <h2>Data grid timeouts (504)</h2>
            <h1>{{ data_grid_timeouts_24_hours }}</h1>
            <h3>In the past 24 hours</h3>
          </a>
        </div>
      {% endif %}
      {% if datacut_grid_errors_24_hours is not None %}
        <div class="stat{% if datacut_grid_errors_24_hours > 0 %} bad-news{% endif %}">
          <a
            target="_blank"
            href="{{ eventlog_url }}?event_type__exact={{ eventlog_model.TYPE_USER_DATACUT_GRID_VIEW_FAILED }}"
          >
            <h2>Data grid query failures (500)</h2>
            <h1>{{ datacut_grid_errors_24_hours }}</h1>
            <h3>In the past 24 hours</h3>
          </a>
        </div>
      {% endif %}
      {% if num_missing_dataset_source_tables is not None %}
        <div class="stat{% if num_missing_dataset_source_tables > 0 %} bad-news{% endif %}">
          <h2>Missing source tables</h2>
          <h1>{{ num_missing_dataset_source_tables }}</h1>
          <h3>{{ num_missing_dataset_source_tables }} table{{ num_missing_dataset_source_tables|pluralize }} missing from the DB</h3>
        </div>
      {% endif %}
      {% if notifications_sent_today is not None %}
        <div class="stat">
          <h2>Dataset notifications sent</h2>
          <h1>{{ notifications_sent_today }}</h1>
          <h3>Today</h3>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
