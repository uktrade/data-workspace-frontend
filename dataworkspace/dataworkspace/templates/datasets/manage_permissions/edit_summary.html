{% extends '_main.html' %}
{% load humanize static datasets_tags core_tags waffle_tags %}

{% block page_title %}{{ obj.name }} - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-three-quarters">
      <div class="govuk-breadcrumbs">
        <ol class="govuk-breadcrumbs__list">
          <li class="govuk-breadcrumbs__list-item">
            <a class="govuk-breadcrumbs__link" href="/">Home</a>
          </li>
          <li class="govuk-breadcrumbs__list-item">
            <a class="govuk-breadcrumbs__link" href="{{ obj.get_absolute_url }}">{{ obj.name }}</a>
          </li>
          <li class="govuk-breadcrumbs__list-item">
            <a class="govuk-breadcrumbs__link" href="{{ obj_edit_url }}">Manage this dataset</a>
          </li>
          <li class="govuk-breadcrumbs__list-item">
            Manage access
          </li>
        </ol>
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}
<dialog id="popup">
  <form id="formRemoveUser" method="get">
    {% csrf_token %}
      <div class="govuk-!-padding-bottom-2">
            <h1 class="govuk-heading-l">Are you sure you want to remove <span id="userToRemove"></span>?</h1>
      </div>
     <div class="govuk-button-group">
      <button class="govuk-button" id="removeUser" data-module="govuk-button" type="submit">Yes, remove user</button>
      <a class="govuk-link" href="#" id="closePopUp">Cancel</button>
    </div>
  </form>
</dialog>
{% if user_removed != None %}
<div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
  <div class="govuk-notification-banner__header">
    <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
      Success
    </h2>
  </div>
  <div class="govuk-notification-banner__content">
    <p class="govuk-body"></p><span id="notificationBannerUserRemovedUserName">{{ user_removed }}'s</span> access to data has been removed. An email has been sent out to let them know they no longer have access to the data.</p>
  </div>
</div>
{% endif %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h1 class="govuk-heading-l">Edit permissions for {{ obj.name }}</h1>
      <table class="govuk-table">
        {% if authorised_users.count > 0 %}
          <caption class="govuk-table__caption govuk-table__caption--m">Users with access</caption>
        {% endif %}
        <tbody class="govuk-table__body">
          {% if authorised_users.count == 0 %}
            <h2 class="govuk-heading-m">There are currently no authorized users</h2>
          {% endif %}
          {% for user in authorised_users %}
            <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header">
                <h3 class="govuk-heading-s">{{ user.first_name }} {{ user.last_name }}</h3>
                <p class="govuk-body">{{ user.email }}</p>
              </th>
              <td class="govuk-table__cell">
                <button type="submit" class="govuk-button govuk-button--secondary" data-module="govuk-button" data-href="{% url 'datasets:remove_authorized_user' obj.id summary.id user.id %}" id="{{ user.first_name }} {{ user.last_name }}">
                  Remove
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="govuk-body">
        <a class="govuk-link" href="{% url 'datasets:dataset_detail' obj.id %}">View catalogue page</a>
      </div>
  </div>
</div>
{% endblock %}
{% block footer_scripts %}
<script nonce="{{ request.csp_nonce }}">

  document.addEventListener("DOMContentLoaded", function () {
    var removeLink;
    document.querySelectorAll('button[data-href]').forEach(function(link){
      link.addEventListener('click', function(event){
        event.preventDefault();
        removeLink = this.getAttribute('data-href')
        user_name = this.getAttribute("id")
        document.getElementById("formRemoveUser").action = removeLink
        document.getElementById('userToRemove').textContent = user_name
        document.getElementById("popup").showModal();
      })
    });
    document.getElementById("closePopUp").addEventListener("click", function (e) {
      e.stopPropagation();
      e.preventDefault();
      document.getElementById("popup").close();
    });
  });
  </script>
{% endblock footer_scripts %}