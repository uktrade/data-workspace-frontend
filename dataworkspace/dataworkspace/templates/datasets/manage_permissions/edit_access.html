{% extends '_main.html' %}
{% load humanize static datasets_tags core_tags waffle_tags %}

{% block page_title %}{{ obj.name }} - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-three-quarters">
      <div class="govuk-breadcrumbs">
        <ol class="govuk-breadcrumbs__list">
          <li class="govuk-breadcrumbs__list-item">
            <a class="govuk-breadcrumbs__link" href="/">Home</a>
          </li>
          <li class="govuk-breadcrumbs__list-item">
            <a class="govuk-breadcrumbs__link" href="{{ obj.get_absolute_url }}">{{ obj.name }}</a>
          </li>
          <li class="govuk-breadcrumbs__list-item">
            <a class="govuk-breadcrumbs__link" href="{{ obj_edit_url }}">Manage this dataset</a>
          </li>
          <li class="govuk-breadcrumbs__list-item">
            Manage access
          </li>
        </ol>
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full ">
            <h1 class="govuk-heading-xl">Manage access to {{ obj.name }}</h1>
            {% if requested_users %} 
             <table class="govuk-table ">
                <caption class="govuk-table__caption govuk-table__caption--l">Users who have requested access</caption>
                    <tbody class="govuk-table__body">
                        {% for user in requested_users %} 
                        <tr class="govuk-table__row">
                        <td class="govuk-table__cell "> <span class="govuk-body govuk-!-font-weight-bold">{{ user.first_name }} {{ user.last_name }}</span>
                            <br> {{ user.email }} <br> 
                            <span class="govuk-caption-m"> Requested: {% if user.days_ago == 0 %} Today {% else %} {{ user.days_ago }} days ago {% endif %}</span>
                            </td>
                        <td class="govuk-table__cell govuk-!-text-align-right"><a class="govuk-link" href="#">Review access request</a></td>
                        </tr>
                    {% endfor %}
                </tbody>
              </table> 
              {% endif %}
            <table class="govuk-table govuk-!-margin-bottom-4">
              <caption class="govuk-table__caption govuk-table__caption--l">Users who have access</caption>
              <tbody class="govuk-table__body">
                {% if authorised_users.count == 0 %}
                  <h2 class="govuk-heading-m">There are currently no authorized users</h2>
                {% endif %}
                {% for user in authorised_users %}
                  <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><span class="govuk-body govuk-!-font-weight-bold">{{ user.first_name }} {{ user.last_name }}</span>
                       {% if user.email in iao %} (Information Asset Owner) {% elif user.email in iam %} (Information Asset Manager) {% elif user.email in data_catalogue_editors %} (Catalogue editor) {% endif%}
                        <br>{{ user.email }}
                    </td>
                    {% if user.email in iao %}
                    <td class="govuk-table__cell"> </td> 
                    {% elif user.email in iam %}
                    <td class="govuk-table__cell"> </td> 

                    {% else %}
                    <td class="govuk-table__cell govuk-!-text-align-right table-cell--vertical-align-middle"><button type="submit" class="govuk-button govuk-button--secondary govuk-!-margin-bottom-0" data-module="govuk-button"><a class="govuk-link" href="{% url 'datasets:remove_authorized_user' obj.id summary.id user.id %}"></a>Remove User</button></td>
                    {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="govuk-body">
                <a class="govuk-link" href="{% url 'datasets:dataset_detail' obj.id %}">View catalogue page</a>
              </div>
        </div>
    </div>
{% endblock %}
{% block footer_scripts %}
<script nonce="{{ request.csp_nonce }}">

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('button[data-href]').forEach(function(link){
      link.addEventListener('click', function(event){
        event.preventDefault();
        document.getElementById("formRemoveUser").action = this.getAttribute('data-href');
        document.getElementById('userToRemove').textContent = this.getAttribute("id");
        document.getElementById("popup").showModal();
      })
    });
    document.getElementById("closePopUp").addEventListener("click", function (e) {
      e.stopPropagation();
      e.preventDefault();
      document.getElementById("popup").close();
    });
  });
  </script>
{% endblock footer_scripts %}
