{% extends '_main.html' %}
{% load humanize static datasets_tags core_tags waffle_tags %}

{% block page_title %}{{ obj.name }} - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-three-quarters">
      <div class="govuk-breadcrumbs">
        <ol class="govuk-breadcrumbs__list">
          <li class="govuk-breadcrumbs__list-item">
            <a class="govuk-breadcrumbs__link" href="/">Home</a>
          </li>
          <li class="govuk-breadcrumbs__list-item">
            <a class="govuk-breadcrumbs__link" href="{{ obj.get_absolute_url }}">{{ obj.name }}</a>
          </li>
          <li class="govuk-breadcrumbs__list-item">
            <a class="govuk-breadcrumbs__link" href="{{ obj_edit_url }}">Manage this dataset</a>
          </li>
          <li class="govuk-breadcrumbs__list-item">
            Manage access
          </li>
        </ol>
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}
<dialog id="popup">
  <form id="formRemoveUser" method="get">
    {% csrf_token %}
      <div class="govuk-!-padding-bottom-2">
            <h1 class="govuk-heading-l">Are you sure you want to remove <span id="userToRemove"></span>?</h1>
      </div>
     <div class="govuk-button-group">
      <button class="govuk-button" id="removeUser" data-module="govuk-button" type="submit">Yes, remove user</button>
      <a class="govuk-link" href="#" id="closePopUp">Cancel</button>
    </div>
  </form>
</dialog>
{% if user_removed != None %}
<div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelled by="govuk-notification-banner-title" data-module="govuk-notification-banner">
  <div class="govuk-notification-banner__header">
    <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
      Success
    </h2>
  </div>
  <div class="govuk-notification-banner__content">
    <p class="govuk-body"></p><span id="notificationBannerUserRemovedUserName">{{ user_removed }}'s</span> access to data has been removed. An email has been sent out to let them know that they no longer have access to the data.</p>
  </div>
</div>
{% endif %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full ">
      <h1 class="govuk-heading-xl">Manage access to {{ obj.name }}</h1>
      {% if requested_users %} 
        <table class="govuk-table ">
          <caption class="govuk-table__caption govuk-table__caption--l">Users who have requested access</caption>
              <tbody class="govuk-table__body">
                  {% for user in requested_users %} 
                  <tr class="govuk-table__row">
                  <td class="govuk-table__cell "> <span class="govuk-body govuk-!-font-weight-bold">{{ user.first_name }} {{ user.last_name }}</span>
                      <br> {{ user.email }} <br> 
                      <span class="govuk-caption-m"> Requested: {% if user.days_ago == 0 %} Today {% else %} {{ user.days_ago }} days ago {% endif %}</span>
                      </td>
                  <td class="govuk-table__cell govuk-!-text-align-right"><a class="govuk-link" href="{% url 'datasets:remove_authorized_user' obj.id summary.id user.id %}">Review access request</a></td>
                  </tr>
              {% endfor %}
          </tbody>
        </table> 
        {% endif %}
      <table class="govuk-table">
        <caption class="govuk-table__caption govuk-table__caption--l">Users who have access</caption>
        <tbody class="govuk-table__body">
          {% if authorised_users.count == 0 %}
            <h2 class="govuk-heading-m">There are currently no authorized users</h2>
          {% endif %}
          {% for user in authorised_users %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell"><span class="govuk-body govuk-!-font-weight-bold">{{ user.first_name }} {{ user.last_name }}</span>
                  {% if user.email in iao %} (Information Asset Owner) {% elif user.email in iam %} (Information Asset Manager) {% elif user.email in data_catalogue_editors %} (Catalogue editor) {% endif%}
                  <br>{{ user.email }}
              </td>
              {% if user.email in iao %}
              <td class="govuk-table__cell"> </td> 
              {% elif user.email in iam %}
              <td class="govuk-table__cell"> </td> 

              {% else %}
              <td class="govuk-table__cell govuk-!-text-align-right ">
                <button type="submit" class="govuk-button govuk-button--secondary govuk-!-margin-bottom-0" data-module="govuk-button" data-href="{% url 'datasets:remove_authorized_user' obj.id summary.id user.id %}" id="{{ user.first_name }} {{ user.last_name }}">Remove User</button>
              </td>
              {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="govuk-body">
          <a class="govuk-link" href="{% url 'datasets:dataset_detail' obj.id %}">View catalogue page</a>
        </div>
  </div>
</div>
{% endblock %}
{% block footer_scripts %}
<script nonce="{{ request.csp_nonce }}">

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('button[data-href]').forEach(function(link){
      link.addEventListener('click', function(event){
        event.preventDefault();
        document.getElementById("formRemoveUser").action = this.getAttribute('data-href');
        document.getElementById('userToRemove').textContent = this.getAttribute("id");
        document.getElementById("popup").showModal();
      })
    });
    document.getElementById("closePopUp").addEventListener("click", function (e) {
      e.stopPropagation();
      e.preventDefault();
      document.getElementById("popup").close();
    });
  });
  </script>
{% endblock footer_scripts %}
