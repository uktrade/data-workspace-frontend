{% extends '_main.html' %}
{% load humanize %}
{% load static %}
{% load core_filters %}
{% load core_tags %}
{% load datasets_tags %}
{% load waffle_tags %}

{% block head %}
  {{ block.super }}
  <script nonce="{{ request.csp_nonce }}" src="{% static 'jquery-3.6.0.min.js' %}"></script>
  <script nonce="{{ request.csp_nonce }}" src="{% static 'gtm-support.js' %}"></script>
{% endblock %}

{% block initialGTMDataLayer %}
  {{ block.super }}
  <script nonce="{{ request.csp_nonce }}">
    dataLayer.push(
      {
        "event": "filter",
        "searchTerms": "{{ query }}",
        "resultsReturned": {{ datasets.paginator.count }},
        {% for field in form %}
          {% if field.field|is_choice_field %}
            "filterData{{ field.name | title }}": "{{ field | get_choice_field_data_for_gtm }}"
            {% if not forloop.last %},{% endif %}
          {% endif %}
        {% endfor %}
      }
    )
  </script>
{% endblock %}

{% block page_title %}Search - {{ block.super }}{% endblock %}

{% block content %}

  <form id="live-search-form" action="{% url 'datasets:find_datasets' %}" method="get">

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <h1 class="govuk-heading-l">Search Data Workspace</h1>
        <p class="govuk-body-l">
          Discover, access and analyse DIT data.
        </p>
      </div>
    </div>

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <div class="search-field govuk-!-margin-bottom-2">
          <label class="govuk-label search-field__label" for="search">Search by dataset name or description</label>
          <div class="search-field-wrapper govuk-!-padding-bottom-6">
            <input type="search" name="q" id="search" title="Search"
                   class="govuk-input search-field__item search-field__input js-class-toggle" value="{{ query }}"
                   aria-controls="search-summary-accessible-hint-wrapper">
            <div class="search-field-submit-wrapper search-field__item">
              <input class="search-field__submit" type="submit" value="Search">
            </div>
          </div>
          {% flag DATASET_FINDER_FLAG %}
            <p class="govuk-body">
              <a href="{% url 'finder:find_datasets' %}" class="govuk-link govuk-link--no-visited-state">Find
                datasets</a> containing a specific word or phrase.
            </p>
          {% endflag %}
        </div>
      </div>
    </div>

    <div id="live-search-wrapper">
      <div class="govuk-grid-row">
        <div
          class="govuk-grid-column-one-third filters-container">

          <div class="govuk-accordion" data-module="govuk-accordion" id="accordion-filters">
            {{ form.my_datasets }}

            {{ form.topic }}
            {{ form.source }}

            {{ form.user_access }}
            {{ form.data_type }}

            {% if show_admin_filters %}
              {{ form.admin_filters }}
            {% endif %}
          </div>

        </div>
        <div class="govuk-grid-column-two-thirds">

          <div id="search-summary-accessible-hint-wrapper" class="govuk-visually-hidden" aria-atomic="true"
               aria-live="polite" aria-relevant="additions text" role="status">
            {{ datasets.paginator.count }} dataset{{ datasets.paginator.count|pluralize }} found.
          </div>

          <div style="border-bottom: 5px solid rgb(11, 12, 12);">

            <p class="govuk-body govuk-!-margin-top-0 govuk-!-margin-bottom-0">
              <span class="govuk-!-font-size-36" role="status"
                    id="search-results-count">{{ datasets.paginator.count }}</span>
              dataset{{ datasets.paginator.count|pluralize }} found.

              {% if has_filters %}
                <span style="float:right;">
                  <span class="govuk-!-font-size-36">&nbsp;</span>
                    <a href="{% url "datasets:find_datasets" %}" class="govuk-link govuk-link--no-visited-state">Remove all filters</a>
                </span>
              {% endif %}
            </p>

            <p class="govuk-body govuk-!-margin-top-4">
              {% for value, text in form.topic.field.choices %}
                {# value is *not* a string but a ModelChoiceIteratorValue. Convert to string first!  #}
                {% if value|stringformat:"s" in form.topic.value %}
                  {% include "datasets/filter_button.html" with id=value text=text tag_type=form.topic.name label="Topic" %}
                {% endif %}
              {% endfor %}

              {% for value, text in form.source.field.choices %}
                {% if value|stringformat:"s" in form.source.value %}
                  {% include "datasets/filter_button.html" with id=value text=text tag_type=form.source.name label="Source" %}
                {% endif %}
              {% endfor %}

              {% for value, text in form.data_type.field.choices %}
                {% if value|stringformat:"s" in form.data_type.value %}
                  {% include "datasets/filter_button.html" with id=value text=text tag_type=form.data_type.name label="Type" %}
                {% endif %}
              {% endfor %}

              {% for value, text in form.user_access.field.choices %}
                {% if value|stringformat:"s" in form.user_access.value %}
                  {% include "datasets/filter_button.html" with id=value text=text tag_type=form.user_access.name label="Access" %}
                {% endif %}
              {% endfor %}

            </p>

          </div>
          <div class="govuk-body govuk-!-margin-top-4">

            <div style="float:right">
              {{ form.sort }}
            </div>

            <div class="govuk-form-group">
              <span class="label__desaturated">
            Page {{ datasets.number }} of {{ datasets.paginator.num_pages }}
                </span>
            </div>


          </div>

          <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
          {% for dataset in datasets %}
            <div class="search-result govuk-!-padding-bottom-4 govuk-!-margin-bottom-4">
              <h3 class="govuk-heading-m">

                <div style="float:right;">
                  {% if dataset.is_bookmarked %}
                    <span title="You have bookmarked this dataset">
                    {% include 'partials/bookmark-yes.html' %}
                    </span>
                  {% else %}
                    <span title="You have not bookmarked this dataset">
                    {% include 'partials/bookmark-no.html' %}
                    </span>
                  {% endif %}

                </div>
                {% include "partials/gtm_dataset_link.html" with event_type="searchResultClick" search_page_number=datasets.number search_result_rank=forloop.counter search_type="search_bar" dataset=dataset %}
                {% if not dataset.published %}
                  <strong class="govuk-tag govuk-tag--grey">
                    Unpublished
                  </strong>
                {% endif %}
              </h3>

              <p class="govuk-body">{{ dataset.short_description }}</p>

              <div class="govuk-body">
                <dl>
                  <dt>Data type:</dt>
                  <dd>{{ data_type|get_key:dataset.data_type }}</dd>
                  <dt>Source:</dt>
                  <dd>
                    {% for source in dataset.source_tag_names %}
                      <a href="{% url "datasets:find_tags" tag_name=source %}"
                         class="govuk-link govuk-link--no-visited-state">{{ source }}</a>
                    {% empty %}
                      N/A
                    {% endfor %}
                  </dd>
                  <dt>Updated:</dt>
                  <dd>
                    {{ dataset.published_at }}
                  </dd>
                  {% if dataset.topic_tag_names %}
                    <dt>Topics:</dt>
                    <dd>
                      {% for topic in dataset.topic_tag_names %}
                        <a href="{% url "datasets:find_tags" tag_name=topic %}"
                           class="govuk-link govuk-link--no-visited-state">{{ topic }}</a>
                      {% empty %}
                        &nbsp;
                      {% endfor %}
                    </dd>
                  {% endif %}
                </dl>
              </div>

              {% if not dataset.has_access %}
                <div class="govuk-inset-text govuk-!-margin-bottom-0">
                  You need to <a href="{% url 'datasets:request_access_from_search_result' dataset.id %}"
                                 class="govuk-link govuk-link--no-visited-state">request access</a> to use this
                  data
                </div>
              {% endif %}

            </div>
          {% endfor %}

          <p class="govuk-body label__desaturated" style="display: inline">
            Displaying results {{ datasets.start_index }}&ndash;{{ datasets.end_index }}
            of {{ datasets.paginator.count }}
          </p>

          {% if datasets.paginator.num_pages > 1 %}
            <nav role="navigation" class="govuk-body" aria-label="Search result page navigation"
                 style="display: inline">
              <ul class="pagination govuk-list">
                {% if datasets.has_previous %}
                  <li><a class="govuk-link" href="{% url_replace page=datasets.previous_page_number %}"
                         aria-label="Previous page">Previous</a></li>
                {% endif %}

                {% if datasets.number > 3 %}
                  <li><a class="govuk-link" href="{% url_replace page=1 %}" aria-label="Page 1">{{ 1 }}</a></li>
                  {% if datasets.number > 4 %}
                    <li>&hellip;</li>{% endif %}
                {% endif %}

                {% for i in datasets.paginator.page_range %}
                  {% if datasets.number == i %}
                    <li class="active">{{ i }}</li>
                  {% elif i >= datasets.number|add:'-2' and i <= datasets.number|add:'2' %}
                    <li><a class="govuk-link" href="{% url_replace page=i %}" aria-label="Page {{ i }}">{{ i }}</a>
                    </li>
                  {% endif %}
                {% endfor %}

                {% if datasets.paginator.num_pages > datasets.number|add:'2' %}
                  {% if datasets.paginator.num_pages > datasets.number|add:'3' %}
                    <li>&hellip;</li>{% endif %}
                  <li><a class="govuk-link" href="{% url_replace page=datasets.paginator.num_pages %}"
                         aria-label="Page {{ datasets.paginator.num_pages }}">{{ datasets.paginator.num_pages }}</a>
                  </li>
                {% endif %}

                {% if datasets.has_next %}
                  <li><a class="govuk-link" href="{% url_replace page=datasets.next_page_number %}"
                         aria-label="Next page">Next</a></li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}

          <div {% if datasets.paginator.count %}class="govuk-!-margin-top-9"{% endif %}>
            <p class="govuk-body">
              {% if datasets.paginator.count %}
                If you haven’t found what you’re looking for, please:
              {% else %}
                There are no results for your search, please:
              {% endif %}
            </p>
            <ul class="govuk-list govuk-list--bullet">
              <li>check the spelling of your keywords</li>
              <li>use more general keywords</li>
              <li>select or deselect different filters</li>
              <li><a class="govuk-link" href="{% url 'request_data:index' %}?tag=data-request">ask for us to add the
                dataset</a></li>
            </ul>
          </div>

        </div>
      </div>
    </div>
  </form>
{% endblock %}

{% block footer_scripts %}
  {% if form.source.field.choices %}
    {{ form.media }}
  {% endif %}

  <script nonce="{{ request.csp_nonce }}" src="{% static 'search-v2.js' %}"></script>
  <script nonce="{{ request.csp_nonce }}">
    $(document).ready(function () {
      var form = new LiveSearch('#live-search-form',
        '#live-search-wrapper',
        new GTMDatasetSearchSupport(), ".dataset-link",
        window.GOVUKFrontend
      );
      var searchInput = new ToggleInputClassOnFocus($("#live-search-form"))
    });
  </script>
{% endblock %}
