{% extends '_visualisation.html' %}
{% load render_bundle from webpack_loader %}

{% load core_filters %}

{% block head %}
{{ block.super }}
{{ form.media }}
{% endblock %}

{% block page_title %}{% if form.errors %}Error: {% endif %}Catalogue item - {{ block.super }}{% endblock %}

{% block content %}
{% if errors %}
<div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
  <h2 class="govuk-error-summary__title" id="error-summary-title">
    There is a problem
  </h2>
  <div class="govuk-error-summary__body">
    <ul class="govuk-list govuk-error-summary__list">
    {% for error_url, error_text in errors %}
        <li>
          <a href="{{ error_url }}">{{ error_text }}</a>
        </li>
    {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<h1 class="govuk-heading-l govuk-!-margin-bottom-6">
  <span class="govuk-caption-l">{{ gitlab_project.name }}</span>
  Publish
</h1>

<p class="govuk-body">
  Before you publish this visualisation to the catalogue you need to release it to production. This makes it viewable to users who have the link.
</p>

<h3 class="govuk-heading-m">
  Release to production
</h3>
{% if approved %}
  <p class="govuk-body">
    You can release your visualisation to production.{{ project_approvals| length }} out of 3 users have approved it.
  </p>
  {% if not visualisation_published %}
    {% include "partials/react-slot-data.html" with mount_id="confirm-publish-visualisation" data='{"is_catalogue": false, "crsf_token": "{ csrf_token }" }' test_id="confirm-publish-visualisation" %}
  {% elif not catalogue_published %}  
    <p class="govuk-body">
      This visualisation has been released to production. This makes it viewable to users who have the link.
    </p>
    <a class="govuk-link" href="{{ visualisation_link }}">Your visualisation can be found here.</a>
    <button name="action" type="submit" class="govuk-button govuk-button--secondary" value="unpublish-visualisation"></button>
    {% include "partials/react-slot-data.html" with mount_id="confirm-publish-visualisation" data='{"is_catalogue": true, "crsf_token": "{ csrf_token }"}'  test_id="confirm-publish-visualisation" %}
  {% else %}
   <button  name="action" type="submit" class="govuk-button govuk-button--secondary" value="unpublish-catalogue" aria-labelledby="catalgoue-explanation">Unpublish catalogue page</button>
  {% endif %}
{% else %}
  <div class="govuk-warning-text">
    <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
    <strong class="govuk-warning-text__text">
      You cannot release your visualisation to production. This is because only {{ project_approvals| length }} out of 3 users{{ project_approvals | pluralize }} {{ project_approvals | pluralize:'has,have' }} approved it.
    </strong>
  </div>
  <div>
    <p class="govuk-body">
      Go to the <a class="govuk-link" href="{% url 'visualisations:approvals' gitlab_project.id %}">approvals section</a> for more information about this process.
    </p>
  </div>
{% endif %}
{% endblock %}
{% block footer_scripts %}
{% render_bundle 'confirm-publish-visualisation' 'js' %}
{% endblock %}